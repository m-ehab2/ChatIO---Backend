{"version":3,"sources":["chatController.js"],"names":["asyncHandler","require","Chat","User","AppError","exports","accessChat","req","res","next","userId","body","find","$and","users","$elemMatch","$eq","user","_id","populate","chatData","path","select","length","status","json","data","newChat","chatName","isGroupChat","create","createChat","findOne","fullChat","fetchChats","sort","updatedAt","then","results","console","log","chats","createGroup","JSON","parse","push","name","groupAdmin","chatGroup","group","renameGroup","chatId","findByIdAndUpdate","runValidators","addUserToGroup","$push","chat","deleteUserFromGroup","$pull"],"mappings":"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","sourcesContent":["\r\nconst asyncHandler = require('express-async-handler');\r\nconst Chat = require('../models/chat');\r\nconst User = require('../models/user');\r\nconst AppError = require('../utils/AppError');\r\nexports.accessChat = asyncHandler(async (req, res, next) => {\r\n    const { userId } = req.body;\r\n    let chatData = await Chat.find({\r\n        $and: [\r\n            { users: { $elemMatch: { $eq: req.user._id } } },\r\n            { users: { $elemMatch: { $eq: userId } } },\r\n        ]\r\n    }).populate(\"users\", \"-password\").populate('message');\r\n    chatData = await User.populate(chatData, {\r\n        path: 'message.sender',\r\n        select:'name image email'\r\n    })\r\n    if (chatData.length>0) {      \r\n        res.status(200).json({\r\n            status: \"success\",\r\n            data:chatData[0]\r\n        })\r\n    } else {\r\n        var newChat = {\r\n            users: [req.user._id, userId],\r\n            chatName: \"sender\",\r\n            isGroupChat:false\r\n        }\r\n        const createChat = await Chat.create(newChat);\r\n\r\n        const fullChat = await Chat.findOne({ _id: createChat._id })\r\n            .populate(\"users\", \"-password\");\r\n        if (!fullChat) {\r\n            throw new AppError(\"the chat not exist\",400)\r\n        }\r\n        res.status(201).json({\r\n            status: \"success\",\r\n            data:fullChat\r\n        })\r\n    }\r\n})\r\nexports.fetchChats = asyncHandler(async (req, res, next) => {\r\n         await Chat.find({ users: { $elemMatch: { $eq: req.user._id } } })\r\n        .populate('users', \"-password\")\r\n        .populate('groupAdmin', '-password')\r\n        .populate('message')\r\n        .sort({ updatedAt: -1 }).\r\n        then(async(results) => {\r\n            results=await User.populate(results, {\r\n                path: 'message.sender',\r\n                select:'name image email'\r\n            })\r\n            res.status(200).json({\r\n                status: \"success\",\r\n                data:results\r\n            })\r\n        })\r\n    next(new AppError('not found any chats for that user',400))\r\n    console.log(chats)\r\n\r\n})\r\nexports.createGroup = asyncHandler(async (req, res, next) => {\r\n    const users = JSON.parse(req.body.users);\r\n    console.log(users);\r\n    if (users.length < 2) {\r\n        return res.status(400).json({\r\n            status: 'Group should be more than 2',\r\n        })\r\n    }\r\n    users.push(req.user);\r\n        const chatGroup = await Chat.create({\r\n        chatName: req.body.name,\r\n        users,\r\n            isGroupChat: true,\r\n        groupAdmin:req.user\r\n        })\r\n    const group = await Chat.findOne({ _id: chatGroup._id })\r\n        .populate('users', '-password')\r\n        .populate('groupAdmin','-password')\r\n\r\n    res.status(200).json({\r\n        status: 'success',\r\n        data:group\r\n    })\r\n})\r\nexports.renameGroup = asyncHandler(async (req, res, next) => {\r\n    const { chatId, chatName } = req.body;\r\n    if (!chatId || !chatName) {\r\n        next(new AppError(\"you should provide chatId and chatName \",400))\r\n    }\r\n    const newChat = await Chat.findByIdAndUpdate(chatId,{\r\n        chatName\r\n    }, {\r\n        new: true,\r\n        runValidators:true\r\n    }).populate('users','-password').populate('groupAdmin','-password');\r\n    res.status(200).json({\r\n        status: 'success',\r\n        data:newChat\r\n    })\r\n})\r\nexports.addUserToGroup = asyncHandler(async (req, res, next) => {\r\n    const { chatId, userId } = req.body;\r\n    const chat = await Chat.findByIdAndUpdate(chatId, {\r\n        $push: { users: userId }\r\n    }, {\r\n        runValidators: true,\r\n        new: true\r\n    }).populate('users','-password').populate('groupAdmin','-password');\r\n    if (!chat) {\r\n        next(new AppError(\"chatId or userId not found\",400));\r\n    }\r\n    res.status(200).json({\r\n        status: 'success',\r\n        data:chat\r\n    })\r\n})\r\nexports.deleteUserFromGroup = asyncHandler(async (req, res, next) => {\r\n    const { chatId, userId } = req.body;\r\n    const chat = await Chat.findByIdAndUpdate(chatId, {\r\n        $pull: { users: userId }\r\n    }, {\r\n        runValidators: true,\r\n        new: true\r\n    }).populate('users','-password').populate('groupAdmin','-password');\r\n    if (!chat) {\r\n        next(new AppError(\"chatId or userId not found\",400));\r\n    }\r\n    res.status(200).json({\r\n        status: 'success',\r\n        data:chat\r\n    })\r\n})\r\n"],"file":"chatController.dev.js"}